# This server block defines the virtual server that will handle incoming requests.
server {
    # Listen on port 8080. This is a common default and the port that
    # Google Cloud Run expects your container to listen on.
    listen 8080;

    # Set the server name (optional, but good practice).
    server_name localhost;

    # The root directory where your built React app's static files are located.
    # This path corresponds to where we copied the /dist folder in the Dockerfile.
    root /usr/share/nginx/html;

    # Specify the default file to serve for directory requests (e.g., when visiting '/').
    index index.html;

    # This 'location' block handles all incoming requests.
    location / {
        # This is the crucial directive for Single Page Applications (SPAs) like React.
        # It tells Nginx how to handle requests for different URLs.
        # 1. $uri: First, it tries to find a file with the exact name of the request URI
        #    (e.g., /assets/logo.png). If found, it serves it.
        # 2. $uri/: If not found, it tries to see if the URI is a directory.
        # 3. /index.html: If neither of the above works (e.g., for a client-side route
        #    like /dashboard or /users/123), it falls back to serving the main index.html file.
        # This allows the React Router library to load and handle the routing on the client's browser.
        try_files $uri $uri/ /index.html;
    }

    # ----- Performance Optimizations: Gzip Compression -----
    # Enable gzip compression to reduce the size of transferred files,
    # leading to faster page loads for your users.
    gzip on;

    # Tell proxies to cache both gzipped and non-gzipped versions of a resource.
    gzip_vary on;

    # Enable compression for all proxied requests.
    gzip_proxied any;

    # Set the compression level (1 is fastest, 9 is best compression). 6 is a good balance.
    gzip_comp_level 6;

    # Allocate buffers for compression.
    gzip_buffers 16 8k;

    # Use gzip for HTTP/1.1 and higher.
    gzip_http_version 1.1;

    # Define the MIME types of files that should be compressed.
    # Do not compress images (jpg, png, etc.) as they are already compressed.
    gzip_types
      application/javascript
      application/json
      application/xml
      image/svg+xml
      text/css
      text/javascript
      text/plain
      text/xml;
}